model ApiAccess {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  trafficSourceType TrafficSourceType?
  apiAccessType     ApiAccessType
  isActive          Boolean
  name              String
  login             String?
  password          String?
  firstAccessToken  String?
  secondAccessToken String?

  trafficSourceBmToApiAccessConnections TrafficSourceBmToApiAccess[]

  @@map("api_access")
}

enum ApiAccessType {
  TRAFFIC_SOURCE_SOC
}

model Log {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())

  name     String?
  message  String?
  isError  Boolean
  workerId Int?
  stack    String?
  request  String?
  response String?
  data     String?

  @@map("log")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
}

model Settings {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @updatedAt

  isActive         Boolean
  name             String
  minWorkerThreads Int
  maxWorkerThreads Int

  @@map("settings")
}

model TaskLoop {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  type        TaskType
  payload     Json?
  intervalMin Float
  isActive    Boolean

  tasks Task[]

  @@map("task-loop")
}

model Task {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  type      TaskType
  payload   Json?
  status    TaskStatus @default(PENDING) // pending | running | done | failed
  result    Json?
  error     String?
  startTime DateTime?
  endTime   DateTime?

  taskLoopId Int?
  taskLoop   TaskLoop? @relation(fields: [taskLoopId], references: [id])

  @@map("task")
}

enum TaskType {
  COLLECT_TRAFFIC_SOURCE_BMS
  COLLECT_TRAFFIC_SOURCE_ACCOUNTS
  COLLECT_TRAFFIC_SOURCE_DAILY_AD_SPEND
}

enum TaskStatus {
  PENDING
  RUNNING
  FAILED
  DONE
}

model TrafficSourceAccount {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  trafficSourceType   TrafficSourceType
  externalId          String
  name                String
  externalStatus      String
  externalCreatedTime DateTime
  status              TrafficSourceAccountStatus?
  balance             Decimal                     @db.Decimal(18, 2)
  externalCurrency    String
  externalTimezone    String
  spendCap            Decimal                     @db.Decimal(18, 2)
  amountSpent         Decimal                     @db.Decimal(18, 2)
  isActive            Boolean                     @default(true)

  trafficSourceOwnerBmId Int?
  trafficSourceOwnerBm   TrafficSourceBm? @relation(fields: [trafficSourceOwnerBmId], references: [id])

  trafficSourceAccountToTrafficSourceBmConnections TrafficSourceAccountToTrafficSourceBm[]
  trafficSourceDailyAdStats                        TrafficSourceDailyAdStat[]

  @@unique([trafficSourceType, externalId])
  @@map("traffic_source_account")
}

enum TrafficSourceAccountStatus {
  ACTIVE
  BLOCK
  PAYMENT_ERROR
  CLOSING
  EXPIRED
}

enum TrafficSourceType {
  FACEBOOK
  TIKTOK
}

model TrafficSourceAccountToTrafficSourceBm {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  trafficSourceBmId      Int
  trafficSourceBm        TrafficSourceBm      @relation(fields: [trafficSourceBmId], references: [id], onDelete: Cascade)
  trafficSourceAccountId Int
  trafficSourceAccount   TrafficSourceAccount @relation(fields: [trafficSourceAccountId], references: [id], onDelete: Cascade)

  @@unique([trafficSourceBmId, trafficSourceAccountId])
  @@map("traffic_source_account_to_traffic_source_bm")
}

model TrafficSourceBm {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  trafficSourceType TrafficSourceType
  externalId        String
  name              String
  isActive          Boolean           @default(true)

  trafficSourceBmToApiAccessConnections            TrafficSourceBmToApiAccess[]
  trafficSourceAccountToTrafficSourceBmConnections TrafficSourceAccountToTrafficSourceBm[]
  accountsOwned                                    TrafficSourceAccount[]

  @@unique([trafficSourceType, externalId])
  @@map("traffic_source_bm")
}

model TrafficSourceBmToApiAccess {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  trafficSourceBmId Int
  trafficSourceBm   TrafficSourceBm @relation(fields: [trafficSourceBmId], references: [id], onDelete: Cascade)
  apiAccessId       Int
  apiAccess         ApiAccess       @relation(fields: [apiAccessId], references: [id], onDelete: Cascade)

  @@unique([trafficSourceBmId, apiAccessId])
  @@map("traffic_source_bm_to_api_access")
}

model TrafficSourceDailyAdStat {
  id         Int      @id @default(autoincrement())
  createDate DateTime @default(now())
  updateDate DateTime @default(now()) @updatedAt

  spend              Decimal           @db.Decimal(18, 2)
  clicks             Int
  externalAdId       String
  externalAdSetId    String
  externalCampaignId String
  impressions        Int
  externalDateStart  DateTime
  externalDateStop   DateTime
  trafficSourceType  TrafficSourceType

  trafficSourceAccountId Int
  trafficSourceAccount   TrafficSourceAccount @relation(fields: [trafficSourceAccountId], references: [id], onDelete: Cascade)

  @@unique([externalDateStart, trafficSourceAccountId, externalAdId])
  @@map("traffic_source_daily_ad_stat")
}
